name: Build and Release GWToolbox Plugins

on: [push]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
    - name: Setup Windows 10 SDK Action
      uses: GuillaumeFalourd/setup-windows10-sdk-action@v2
      with:
        sdk-version: 22621

    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Clone GWToolboxpp
      run: |
        git clone https://github.com/gwdevhub/GWToolboxpp.git ${{runner.workspace}}/GWToolboxpp

    - name: Copy plugins to GWToolboxpp
      run: |
        # Remove existing plugins (except Base, which is required)
        if (Test-Path "${{runner.workspace}}/GWToolboxpp/plugins") {
          Get-ChildItem -Path "${{runner.workspace}}/GWToolboxpp/plugins" -Directory | Where-Object { $_.Name -ne "Base" } | Remove-Item -Recurse -Force
          Write-Host "Cleared existing plugins directory (preserved Base)"
        }
        
        Get-ChildItem -Path ${{github.workspace}} -Directory | Where-Object { $_.Name -ne ".github" -and $_.Name -ne ".git" -and $_.Name -notin @("README.md", "job-logs.txt") } | ForEach-Object {
          $pluginName = $_.Name
          Write-Host "Copying plugin: $pluginName"
          Copy-Item -Path $_.FullName -Destination "${{runner.workspace}}/GWToolboxpp/plugins/$pluginName" -Recurse -Force
        }

    - name: Update CMake plugins file
      run: |
        $pluginsFile = "${{runner.workspace}}/GWToolboxpp/cmake/gwtoolboxdll_plugins.cmake"
        
        # Read all lines
        $lines = Get-Content $pluginsFile
        
        # Remove the last line containing add_tb_plugin(ExamplePlugin)
        if ($lines[-1] -match "add_tb_plugin\(ExamplePlugin\)") {
          $lines = $lines[0..($lines.Length-2)]
          Write-Host "Removed ExamplePlugin line from CMake file"
        }
        
        # Write back the content without the ExamplePlugin line
        Set-Content $pluginsFile -Value $lines
        
        # Add plugins from this repository
        $ourPlugins = Get-ChildItem -Path ${{github.workspace}} -Directory | Where-Object { $_.Name -ne ".github" -and $_.Name -ne ".git" -and $_.Name -notin @("README.md", "job-logs.txt", "plugin-dlls") }
        
        foreach ($plugin in $ourPlugins) {
          $pluginName = $plugin.Name
          Write-Host "Adding plugin to CMake: $pluginName"
          Add-Content $pluginsFile -Value "add_tb_plugin($pluginName)"
        }

    - name: Cache CMake dependency source code
      continue-on-error: true
      uses: actions/cache@v4
      env:
        cache-name: cache-cmake-dependency-sources
      with:
        path: ${{runner.workspace}}/GWToolboxpp/build/_deps/*-src
        key: ${{ env.cache-name }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
        restore-keys: |
          ${{ env.cache-name }}-

    - name: Cache CMake dependency build objects
      continue-on-error: true
      uses: actions/cache@v4
      env:
        cache-name: cache-cmake-dependency-builds
      with:
        path: |
          ${{runner.workspace}}/GWToolboxpp/build/_deps/*-build
          ${{runner.workspace}}/GWToolboxpp/build/_deps/*-subbuild
        key: ${{ env.cache-name }}-${{ runner.os }}-relwithdebinfo-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
        restore-keys: |
          ${{ env.cache-name }}-${{ runner.os }}-relwithdebinfo-

    - name: Checkout GWToolboxpp submodules
      shell: bash
      working-directory: ${{runner.workspace}}/GWToolboxpp
      run: git submodule update --init --recursive
      
    - name: Install vcpkg
      working-directory: ${{runner.workspace}}/GWToolboxpp
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        
    - name: Set VCPKG_ROOT
      run: |
        echo "VCPKG_ROOT=${{runner.workspace}}/GWToolboxpp/vcpkg" >> $env:GITHUB_ENV
      shell: powershell
      
    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Create Build Environment
      run: cmake -E make_directory ${{runner.workspace}}/GWToolboxpp/build

    - name: Configure CMake
      shell: bash
      working-directory: ${{runner.workspace}}/GWToolboxpp/build
      run: cmake "${{runner.workspace}}/GWToolboxpp" --preset=vcpkg
      env:
        VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
        VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    - name: Build
      working-directory: ${{runner.workspace}}/GWToolboxpp/build
      shell: bash
      run: cmake --build . --config RelWithDebInfo

    - name: Collect plugin DLLs
      run: |
        mkdir ${{github.workspace}}/plugin-dlls
        
        # GWToolboxpp outputs binaries to bin/RelWithDebInfo in the project root
        $searchDir = "${{runner.workspace}}/GWToolboxpp/bin/RelWithDebInfo"
        
        Write-Host "Searching for DLLs in: $searchDir"
        
        # Get our plugins list again to know what to look for
        $ourPlugins = Get-ChildItem -Path ${{github.workspace}} -Directory | Where-Object { $_.Name -ne ".github" -and $_.Name -ne ".git" -and $_.Name -notin @("README.md", "job-logs.txt") }
        
        foreach ($plugin in $ourPlugins) {
          $pluginName = $plugin.Name
          Write-Host "Looking for DLL for: $pluginName"
          
          if (Test-Path $searchDir) {
            # Check specifically for the DLL in the RelWithDebInfo directory
            $dllPath = Join-Path $searchDir "$pluginName.dll"
            if (Test-Path $dllPath) {
              Write-Host "Found DLL at: $dllPath"
              Copy-Item $dllPath "${{github.workspace}}/plugin-dlls/" -Force
            } else {
              Write-Host "DLL not found at expected path: $dllPath"
              # Fallback search in bin just in case
              $dllFiles = Get-ChildItem -Path "${{runner.workspace}}/GWToolboxpp/bin" -Filter "$pluginName.dll" -Recurse -ErrorAction SilentlyContinue
              if ($dllFiles) {
                 Write-Host "Found DLL via fallback search at: $($dllFiles[0].FullName)"
                 Copy-Item $dllFiles[0].FullName "${{github.workspace}}/plugin-dlls/" -Force
              } else {
                 Write-Host "Listing contents of $searchDir`:"
                 Get-ChildItem -Path $searchDir | Select-Object Name
              }
            }
          } else {
            Write-Host "Search directory $searchDir does not exist."
            Write-Host "Checking bin root..."
            if (Test-Path "${{runner.workspace}}/GWToolboxpp/bin") {
               Get-ChildItem -Path "${{runner.workspace}}/GWToolboxpp/bin" -Recurse -Depth 2 | Select-Object FullName
            }
          }
        }

    - name: Create ZIP of plugin DLLs
      run: |
        Compress-Archive -Path "${{github.workspace}}/plugin-dlls/*" -DestinationPath "${{github.workspace}}/gwtoolbox-plugins.zip"

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: plugins-${{ github.run_number }}
        release_name: GWToolbox Plugins Release ${{ github.run_number }}
        body: |
          Auto-generated release containing GWToolbox plugin DLLs.
          
          Built from commit: ${{ github.sha }}
          
          This release contains only the compiled plugin DLL files.
        draft: false
        prerelease: false

    - name: Upload Plugin DLLs to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{github.workspace}}/gwtoolbox-plugins.zip
        asset_name: gwtoolbox-plugins.zip
        asset_content_type: application/zip